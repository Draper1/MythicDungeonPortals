name: ğŸ§ª Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ Setup Python (for Lua installation)
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: ğŸ“¦ Install Lua
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.4
        
    - name: ğŸ§ª Run Tests
      run: |
        lua test-runner.lua
        
    - name: ğŸ“Š Test Results
      if: always()
      run: |
        echo "âœ… Tests completed!"
        echo "ğŸ“ Test files checked:"
        find tests/ -name "*.lua" -type f
        
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ Install Lua
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.4
        
    - name: ğŸ” Basic Syntax Check
      run: |
        echo "ğŸ” Checking Lua syntax..."
        for file in $(find . -name "*.lua" -not -path "./tests/*"); do
          echo "Checking $file"
          # Use a simple syntax check that compiles the file without executing it
          lua -e "local f = io.open('$file', 'r'); if f then local content = f:read('*a'); f:close(); loadstring(content); print('âœ… $file syntax OK') else print('âŒ $file not found') end" 2>/dev/null || echo "âŒ $file syntax error"
        done
        
    - name: ğŸ“‹ File Structure Check
      run: |
        echo "ğŸ“‹ Checking required files exist..."
        required_files=("MythicDungeonPortals.toc" "MythicDungeonPortals.lua" "Constants.lua" "Init.lua")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
